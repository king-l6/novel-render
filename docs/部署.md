# 部署指南：线上运行，手机访问

把项目部署到一台**有公网 IP 或域名的服务器**上，即可在手机浏览器里打开网址看书。

---

## 一、部署方式概览

| 方式 | 适用 | 难度 | 说明 |
|------|------|------|------|
| **云服务器 + Node** | 有 Linux 服务器（阿里云/腾讯云/自建等） | 中 | 用 pm2 保活，可选 nginx 反代 + HTTPS |
| **PaaS 一键部署** | 想快速上线、少折腾 | 低 | Railway / Render / Fly.io 等，绑定 Git 自动构建 |

下面分别说明。

---

## 二、方式 A：云服务器（VPS）部署

### 1. 环境要求

- 一台 Linux 服务器（Ubuntu / Debian / CentOS 等），有公网 IP
- 已安装 **Node.js 18+**、**pnpm**

```bash
# 示例：Ubuntu 安装 Node 与 pnpm
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs
sudo npm install -g pnpm
```

### 2. 上传代码并构建

在**本机**打包（或直接在服务器上 `git clone` 后执行）：

```bash
# 在项目根目录
pnpm install
pnpm run build
```

把整个项目目录上传到服务器（如 `/home/you/novel-reader`），确保包含 `frontend/dist` 和 `node_modules`。若在服务器上 clone，则在该目录执行：

```bash
pnpm install
pnpm run build
```

### 3. 生产环境变量（推荐）

在服务器上设置环境变量，避免使用默认的 session 密钥：

```bash
export PORT=3000
export SESSION_SECRET="你的随机长字符串，用于加密登录态"
```

可写入 `~/.bashrc` 或新建 `server/.env` 并在启动前 `source`，或用下面的 pm2 方式注入。

### 4. 用 PM2 保活（推荐）

安装 pm2 并以后台方式启动，进程挂了会自动重启：

```bash
sudo npm install -g pm2

cd /home/you/novel-reader
pm2 start server/index.js --name novel-reader
pm2 save
pm2 startup   # 按提示执行，实现开机自启
```

若需指定端口和 SESSION_SECRET：

```bash
PORT=3000 SESSION_SECRET="你的随机密钥" pm2 start server/index.js --name novel-reader
```

查看状态：`pm2 status`；看日志：`pm2 logs novel-reader`。

### 5. 手机访问

- 服务器防火墙放行 **3000** 端口（或你设置的 `PORT`）。
- 手机和电脑在同一网络或手机用流量时，在浏览器输入：**http://你的公网IP:3000**  
  例如：`http://123.45.67.89:3000`。

此时已经可以从手机在线看书。

### 6. 可选：域名 + HTTPS（更安全、更好记）

若你有域名并希望用 `https://read.你的域名.com` 访问：

1. **安装 nginx**（以 Ubuntu 为例）：
   ```bash
   sudo apt update && sudo apt install -y nginx certbot python3-certbot-nginx
   ```

2. **申请证书并配置 nginx**：
   ```bash
   sudo certbot --nginx -d read.你的域名.com
   ```
   按提示选择域名并完成证书申请，certbot 会自动写 nginx 配置。

3. **手动配置 nginx 反代**（若 certbot 未自动写好）  
   编辑 `/etc/nginx/sites-available/novel-reader`（或 default）：

   ```nginx
   server {
       listen 80;
       server_name read.你的域名.com;
       location / {
           proxy_pass http://127.0.0.1:3000;
           proxy_http_version 1.1;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
   }
   ```

   然后：
   ```bash
   sudo ln -sf /etc/nginx/sites-available/novel-reader /etc/nginx/sites-enabled/
   sudo nginx -t && sudo systemctl reload nginx
   ```

4. 用 **https://read.你的域名.com** 在手机浏览器打开即可。

---

## 三、方式 B：PaaS 一键部署（Railway / Render 等）

适合「不想管服务器、希望 Git 推送就自动部署」的场景。

### Railway 示例

1. 注册 [Railway](https://railway.app)，新建项目，选择 **Deploy from GitHub** 并选本仓库。
2. 在项目里添加 **Environment Variables**：
   - `PORT`：一般由 Railway 自动提供，可不设或填 `3000`
   - `SESSION_SECRET`：自己填一长串随机字符串
3. 在 **Settings** 里把 **Root Directory** 设为仓库根目录，**Build Command** 填：
   ```bash
   pnpm install && pnpm run build
   ```
   **Start Command** 填：
   ```bash
   node server/index.js
   ```
   （若 Railway 默认用 `npm start`，且你 `package.json` 里 `start` 已是 `node server/index.js`，则不用改 Start Command。）
4. 部署完成后，Railway 会给你一个 `xxx.railway.app` 的域名，手机浏览器打开该链接即可。

### Render 示例

1. 注册 [Render](https://render.com)，New → Web Service，连 GitHub 选仓库。
2. 配置：
   - **Build Command**：`pnpm install && pnpm run build`
   - **Start Command**：`node server/index.js`
   - **Environment**：添加 `SESSION_SECRET`（随机字符串）。
3. 部署完成后用给出的 `xxx.onrender.com` 域名在手机访问。

> 注意：Render 免费实例一段时间无访问会休眠，首次打开可能较慢；数据库（SQLite 文件）在实例重启后可能被清空，重要数据请定期备份或改用持久化存储。

---

## 四、安全检查清单

- [ ] 线上务必设置 **SESSION_SECRET**，不要用代码里的默认值。
- [ ] 若用 VPS，只开放必要端口（如 80/443），应用端口（如 3000）可不对外，交给 nginx 反代。
- [ ] 上线后尽快修改默认管理员密码（默认 `admin` / `admin123`）。

---

## 五、数据与备份

- 书籍和进度在 **server/data/novel-reader.db**。
- 定期备份该文件即可保留全部用户与阅读数据，例如：
  ```bash
  cp server/data/novel-reader.db server/data/novel-reader.db.bak.$(date +%Y%m%d)
  ```

部署完成后，在手机浏览器打开你配置的地址（如 `http://公网IP:3000` 或 `https://你的域名`），登录账号即可在线看书。
