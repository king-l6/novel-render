# 部署指南：手机在线看书

多种**云托管**（电脑可关机）+ 一种**本机隧道**（电脑开着才能用）。云托管用项目里的 **Dockerfile** 构建，走公网 npm，避免之前 Render 的 nexus 报错。

**不想绑信用卡？**  
- **Zeabur**：支持手机验证，无需信用卡，连 GitHub 用 Dockerfile 部署（见下方「方式三」）。  
- **自家电脑 + Cloudflare Tunnel**：完全不用云平台、不绑卡，电脑开机即可用（见 [部署-本机隧道.md](./部署-本机隧道.md) 或下方「方式五」）。  
- Railway / Render / Fly.io 目前多数需绑定信用卡或支付方式才能创建应用，若你遇到同样情况可改用上面两种。

---

## 用 Docker 部署本项目（学习篇）

想自己用 Docker 跑一遍、或以后改 Dockerfile 时，可以按下面步骤来。

### 1. 本项目的 Docker 相关文件

- **Dockerfile**（项目根目录）：定义「镜像」怎么构建——用哪个基础镜像、装依赖、构建前端、最后运行谁。
- **.dockerignore**：构建时**不**把哪些文件拷进镜像（如 `node_modules`、`.git`、`server/data`），加快构建、减小镜像体积。

### 2. Dockerfile 在做什么（逐段看）

```dockerfile
FROM node:20-alpine
```
基于 Node 20 的 Alpine 镜像（体积小），相当于在一个干净的 Linux 里用 Node。

```dockerfile
WORKDIR /app
```
之后所有命令都在容器里的 `/app` 目录执行。

```dockerfile
ENV NPM_CONFIG_REGISTRY=https://registry.npmjs.org/
```
让容器里的 npm 只用公网源，避免公司内网 nexus 导致构建失败。

```dockerfile
COPY package.json ./
RUN npm install --ignore-scripts
```
先只复制 `package.json`，再装根目录依赖。这样只要 `package.json` 不变，这一层会被缓存，不用每次都重新 `npm install`。

```dockerfile
COPY frontend/package.json frontend/
RUN cd frontend && npm install --ignore-scripts
```
同理，装前端的依赖，利用层缓存。

```dockerfile
COPY . .
RUN npm run build
```
把整个项目拷进去（`.dockerignore` 里排除的不会进镜像），然后执行 `npm run build` 构建前端，得到 `frontend/dist`。

```dockerfile
EXPOSE 3000
ENV PORT=3000
CMD ["node", "server/index.js"]
```
声明容器内服务占 3000 端口；启动时执行 `node server/index.js`，即本项目的后端（同时托管前端静态文件）。

### 3. 本地用 Docker 构建并运行

**前提**：本机已安装 [Docker Desktop](https://www.docker.com/products/docker-desktop/)（或 Linux 上的 docker 引擎）。

在**项目根目录**（和 Dockerfile 同级）打开终端：

**3.1 构建镜像**

```bash
docker build -t novel-reader .
```

- `-t novel-reader`：给镜像起名为 `novel-reader`。
- `.`：用当前目录作为「构建上下文」，Docker 会按 `.dockerignore` 排除后把文件发给 Docker 构建。

第一次会拉 Node 镜像、装依赖、构建前端，可能要几分钟。以后改代码再构建，未变的层会复用缓存。

**3.2 运行容器**

```bash
docker run -d -p 3000:3000 -e SESSION_SECRET=你的随机密钥 --name novel novel-reader
```

- `-d`：后台运行。
- `-p 3000:3000`：把本机 3000 端口映射到容器内 3000。
- `-e SESSION_SECRET=...`：传入环境变量（登录态加密用，生产务必设）。
- `--name novel`：容器名叫 `novel`，方便后面 `docker stop novel`。
- `novel-reader`：用刚才构建的镜像名。

然后在浏览器打开 [http://localhost:3000](http://localhost:3000)，能登录、看书即表示成功。

**3.3 数据持久化（可选）**

默认容器删掉后，里面的 `server/data/novel-reader.db` 也会没。若希望数据留在本机，可以用**挂载卷**：

```bash
docker run -d -p 3000:3000 -e SESSION_SECRET=你的随机密钥 \
  -v novel-data:/app/server/data \
  --name novel novel-reader
```

`-v novel-data:/app/server/data` 表示把 Docker 管理的卷 `novel-data` 挂到容器内的 `/app/server/data`，数据库文件会保存在卷里，删容器再起一个新容器用同一卷，数据还在。

**3.4 常用命令**

```bash
docker ps              # 看正在跑的容器（有 novel 即正常）
docker logs novel      # 看日志
docker stop novel      # 停掉
docker start novel     # 再启动（数据在卷里的话会保留）
docker rm -f novel     # 删容器（卷不删的话数据还在）
```

### 4. 和云托管的关系

- **Railway / Render**：连 GitHub 后，平台在云端执行类似 `docker build`（用你仓库里的 Dockerfile），再在它们的服务器上 `docker run`，所以你本机不用自己推镜像，只要 push 代码即可。
- 想**自己**把镜像推到 Docker Hub 再在别处拉镜像跑，可以：
  ```bash
  docker tag novel-reader 你的用户名/novel-reader:latest
  docker push 你的用户名/novel-reader:latest
  ```
  然后在任何有 Docker 的机器上 `docker pull 你的用户名/novel-reader:latest` 再 `docker run`。

---

## 方式一：Railway（推荐，用 Docker 部署）

**优点**：连 GitHub 即可，自动用仓库里的 Dockerfile 构建，不用填 Build Command；免费试用额度用完后每月约 $1 额度，小应用够用。  
**限制**：需绑定信用卡或手机号（试用不扣费）；额度用尽需充值或换平台。

### 步骤

1. 打开 [railway.app](https://railway.app)，用 **GitHub** 登录。
2. 点 **New Project** → **Deploy from GitHub repo**，选你的 `novel-reader` 仓库（若没有，先按「方式二」里 1. 把代码推到 GitHub）。
3. 部署创建后，点进该 **Service** → 选 **Variables**，点 **Add Variable**：
   - 名：`SESSION_SECRET`  
   - 值：一长串随机英文+数字（如 `mySecret2024Xyz`），保存。
4. 若 Railway 没有自动识别 Docker：在 Service 的 **Settings** 里找到 **Build**，确认使用的是 **Dockerfile**（根目录的 `Dockerfile`），不要用 Nixpacks/Node 的自动检测。
5. 等构建和部署完成（日志里出现 “Listening” 或 “Running” 即可）。点 **Settings** → **Networking** → **Generate Domain**，会得到一个 `https://xxx.up.railway.app`。
6. 用手机浏览器打开该链接，**admin** / **admin123** 登录。建议登录后到「管理」里改默认密码。

之后改代码：本机 `git push`，Railway 会自动重新构建并部署。

---

## 方式二：Render（用 Docker 部署，避免 nexus 报错）

**优点**：免费档每月约 750 小时；用 Docker 构建时在镜像里跑 npm，不会走你本机/公司 nexus。  
**限制**：约 15 分钟无访问会休眠，下次打开要等几十秒；免费实例重启后数据可能清空；**部分用户反馈仍需绑定信用卡才能创建服务**，若遇此情况请用下方 **Zeabur** 或 **自家电脑 + Cloudflare Tunnel**。

### 步骤

1. **代码在 GitHub**：若还没有，到 [github.com](https://github.com) 新建仓库，在本机项目根目录执行（把 `你的用户名`、`novel-reader` 换成你的）：

   ```bash
   git init
   git add .
   git commit -m "init"
   git branch -M main
   git remote add origin https://github.com/你的用户名/novel-reader.git
   git push -u origin main
   ```

2. 打开 [render.com](https://render.com)，用 **GitHub** 登录。
3. 点 **New +** → **Web Service**，在 **Connect a repository** 里选你的 `novel-reader` 仓库并 **Connect**。
4. **重要**：在创建页把 **Runtime**（或 **Language**）选成 **Docker**，不要选 Node。这样 Render 会用你仓库根目录的 **Dockerfile** 构建，不会用自己的 pnpm/npm 和源。
5. 其他可保持默认，**Instance Type** 选 **Free**。不需要填 Build Command（Docker 构建由 Dockerfile 决定）。
6. 在 **Environment Variables** 里点 **Add Environment Variable**：  
   **Key**：`SESSION_SECRET`  
   **Value**：一长串随机字符，保存。
7. 点 **Create Web Service**，等构建和部署完成（约 3～5 分钟）。顶部会给出 `https://xxx.onrender.com`。
8. 手机浏览器打开该链接，**admin** / **admin123** 登录。

之后改代码：本机 `git push`，Render 会自动重新构建部署。

---

## 方式三：Zeabur（无需信用卡，推荐不想绑卡时用）

**优点**：**无需绑定信用卡**，可用手机号等方式验证；连 GitHub 部署，支持 Dockerfile；免费额度约 $5/月，小应用够用。  
**限制**：需注册 Zeabur 并完成账户验证（无需信用卡）。

### 步骤

1. **代码在 GitHub**：若还没有，在项目根目录执行（把 `你的用户名`、`novel-reader` 换成你的）：
   ```bash
   git init
   git add .
   git commit -m "init"
   git branch -M main
   git remote add origin https://github.com/你的用户名/novel-reader.git
   git push -u origin main
   ```

2. 打开 [zeabur.com](https://zeabur.com)，用 **GitHub** 或邮箱注册并登录。创建项目时按提示做**账户验证**（选手机验证等，无需信用卡）。

3. 在项目里点 **Add Service** → **GitHub**，选择你的 `novel-reader` 仓库并导入。

4. Zeabur 会识别仓库；若需指定用 Docker 构建，在服务设置里选择使用 **Dockerfile**（项目根目录）。在 **Variables** 里添加环境变量：  
   **Key**：`SESSION_SECRET`  
   **Value**：一长串随机字符，保存。

5. 部署完成后，在 **Networking** 里为该服务生成公网访问地址（如 `https://xxx.zeabur.app`）。

6. 用手机浏览器打开该链接，**admin** / **admin123** 登录，并尽快在「管理」里改默认密码。

之后改代码：本机 `git push`，Zeabur 会自动重新构建并部署。

---

## 方式四：Fly.io（命令行一键部署）

**优点**：有 `fly.toml` 即可用 CLI 部署，无需先推 GitHub；免费档有每月约 3 台共享 CPU、160GB 出站等额度。  
**注意**：Fly.io 目前要求账号**先绑定信用卡或购买额度**才能创建应用（见 [Billing](https://fly.io/dashboard)）。若不想绑卡，请用 **Zeabur** 或 **自家电脑 + Cloudflare Tunnel**。另需安装 [flyctl](https://fly.io/docs/hands-on/install-flyctl/)（`brew install flyctl`）、`fly auth login` 登录；应用名需全球唯一，若 `novel-reader` 被占用，请改 `fly.toml` 里 `app = "novel-reader-你的英文名"`。

### 步骤

1. **安装并登录**（未做过的话）：
   ```bash
   brew install flyctl
   fly auth login
   ```

2. **在项目根目录首次部署**：
   ```bash
   cd /Users/bilibili/novel-reader
   fly launch --no-deploy
   ```
   按提示选择组织、区域；若提示应用名已被占用，在 `fly.toml` 里把 `app` 改成唯一名字后重新执行：
   ```bash
   fly launch --no-deploy
   ```

3. **设置生产环境密钥**（必做）：
   ```bash
   fly secrets set SESSION_SECRET=你的随机长字符串
   ```
   例如：`fly secrets set SESSION_SECRET=mySecret2024XyzAbc123`

4. **构建并部署**：
   ```bash
   fly deploy
   ```
   等待构建和发布完成，终端会给出 `https://xxx.fly.dev`。

5. 浏览器打开该链接，用 **admin** / **admin123** 登录，并尽快在「管理」里修改默认密码。

之后改代码：在同一目录执行 `fly deploy` 即可重新部署。

---

## 方式五：自家电脑 + Cloudflare Tunnel（不依赖云、完全无需绑卡）

**条件**：用的时候电脑要开着，两个终端保持运行。  
**优点**：不依赖任何云平台、**无需注册云服务、无需信用卡**；Cloudflare Tunnel 免费，数据在本地。  
**详细步骤**：见 [部署-本机隧道.md](./部署-本机隧道.md)。

1. 本机项目根目录执行：`pnpm install` → `pnpm run build` → `pnpm start`，浏览器打开 [http://localhost:3000](http://localhost:3000) 确认能访问。
2. 再开一个终端，执行：`cloudflared tunnel --url http://localhost:3000`（未安装 cloudflared 的：Mac 用 `brew install cloudflared`，Windows 到 [cloudflared  releases](https://github.com/cloudflare/cloudflared/releases) 下载并加入 Path）。
3. 终端里会出现 `https://xxx.trycloudflare.com`，用手机浏览器打开即可。

---

## 安全与数据

- **SESSION_SECRET**：云托管时在平台的环境变量里务必设成随机字符串。
- **默认密码**：上线后尽快在「管理」里改掉 **admin** / **admin123**。
- **数据**：书籍和进度在 **server/data/novel-reader.db**。云托管免费实例重启后可能丢失；本机 + Tunnel 时数据在你电脑，请定期备份该文件。

---

**建议**：**不想绑信用卡** → 用 **Zeabur**（云托管）或 **自家电脑 + Cloudflare Tunnel**（本机隧道）。可以接受绑卡 → 用 **Railway**、**Render（选 Docker）** 或 **Fly.io**。
