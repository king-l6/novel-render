# 部署指南：线上运行，手机访问

把项目部署到一台**有公网 IP 或域名的服务器**上，即可在手机浏览器里打开网址看书。

---

## 免费且简单：用 Render 一步步部署（推荐）

**特点**：完全免费、不用买服务器、不用敲命令行，用网页点一点就能上线；手机浏览器打开给的链接即可看书。  
**限制**：免费实例约 15 分钟无人访问会休眠，下次打开可能要等 30 秒～1 分钟唤醒；数据在实例重启后可能丢失，适合个人随手用，重要书请本地留备份。

### 第 1 步：把代码放到 GitHub

1. 打开 [GitHub](https://github.com)，登录或注册。
2. 点击右上角 **+** → **New repository**。
3. 仓库名随便起（如 `novel-reader`），选 **Private** 或 **Public**，不勾选 “Add a README”，点 **Create repository**。
4. 在本机项目根目录（有 `package.json` 的那层）打开终端，执行（把 `你的用户名`、`novel-reader` 换成你的仓库名）：
   ```bash
   git init
   git add .
   git commit -m "init"
   git branch -M main
   git remote add origin https://github.com/你的用户名/novel-reader.git
   git push -u origin main
   ```
   若已有 git 且已连过 GitHub，只需 `git push` 即可。

### 第 2 步：注册 Render 并创建 Web Service

1. 打开 [Render](https://render.com)，点 **Get Started for Free**。
2. 用 **GitHub** 登录（Authorize Render），允许它访问你的仓库。
3. 登录后点 **Dashboard** 里的 **New +** → **Web Service**。
4. 在 **Connect a repository** 里找到你刚推送的 `novel-reader`（或你起的名字），点 **Connect**。  
   若看不到仓库，点 **Configure account** 勾选该仓库再回来选。

### 第 3 步：填服务配置（按下面一字不差填）

在创建页按下面填，其他保持默认即可：

| 项 | 填什么 |
|----|--------|
| **Name** | 随便，如 `novel-reader`（会出现在你的服务 URL 里） |
| **Region** | 选离你近的，如 **Singapore** |
| **Branch** | `main`（或你推送的分支名） |
| **Runtime** | **Node** |
| **Build Command** | `corepack enable && pnpm install && pnpm run build` |
| **Start Command** | `node server/index.js` |
| **Instance Type** | 选 **Free** |

### 第 4 步：加环境变量（必做）

1. 在同一个页面往下滚，找到 **Environment** 或 **Environment Variables**，点 **Add Environment Variable**。
2. 添加一条：
   - **Key**：`SESSION_SECRET`
   - **Value**：随便一长串英文+数字，例如 `myNovelReaderSecret2024AbcXyz`（不要用这句原样，自己改几个字）。
3. 点 **Save** 或继续下一步。

### 第 5 步：创建并等部署完成

1. 点页面底部 **Create Web Service**。
2. 等 2～5 分钟，页面会显示 **Building…** 再变成 **Live**。
3. 顶部会出现一行链接，形如：**https://novel-reader-xxxx.onrender.com**，点进去就是你的阅读器。

### 第 6 步：手机访问

1. 用手机浏览器（Safari / Chrome 等）打开上一步的链接，例如：  
   `https://novel-reader-xxxx.onrender.com`
2. 第一次打开若是休眠，可能要等约 30 秒才出现登录页。
3. 默认管理员账号：**admin**，密码：**admin123**。登录后即可上传 TXT、在手机上看书。
4. 建议登录后到「管理」里改掉默认管理员密码。

### 之后：改代码后自动重新部署

在本机改完代码后执行：

```bash
git add .
git commit -m "更新说明"
git push
```

Render 会自动重新构建并部署，过几分钟用同一链接再打开就是新版本。

### 小结（复制用）

- **Build Command**：`corepack enable && pnpm install && pnpm run build`
- **Start Command**：`node server/index.js`
- **环境变量**：`SESSION_SECRET` = 你的随机字符串
- **实例类型**：Free

---

## 一、部署方式概览

| 方式 | 适用 | 难度 | 说明 |
|------|------|------|------|
| **云服务器 + Node** | 有 Linux 服务器（阿里云/腾讯云/自建等） | 中 | 用 pm2 保活，可选 nginx 反代 + HTTPS |
| **PaaS 一键部署** | 想快速上线、少折腾 | 低 | Railway / Render / Fly.io 等，绑定 Git 自动构建 |

下面分别说明。

---

## 二、方式 A：云服务器（VPS）部署

### 1. 环境要求

- 一台 Linux 服务器（Ubuntu / Debian / CentOS 等），有公网 IP
- 已安装 **Node.js 18+**、**pnpm**

```bash
# 示例：Ubuntu 安装 Node 与 pnpm
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs
sudo npm install -g pnpm
```

### 2. 上传代码并构建

在**本机**打包（或直接在服务器上 `git clone` 后执行）：

```bash
# 在项目根目录
pnpm install
pnpm run build
```

把整个项目目录上传到服务器（如 `/home/you/novel-reader`），确保包含 `frontend/dist` 和 `node_modules`。若在服务器上 clone，则在该目录执行：

```bash
pnpm install
pnpm run build
```

### 3. 生产环境变量（推荐）

在服务器上设置环境变量，避免使用默认的 session 密钥：

```bash
export PORT=3000
export SESSION_SECRET="你的随机长字符串，用于加密登录态"
```

可写入 `~/.bashrc` 或新建 `server/.env` 并在启动前 `source`，或用下面的 pm2 方式注入。

### 4. 用 PM2 保活（推荐）

安装 pm2 并以后台方式启动，进程挂了会自动重启：

```bash
sudo npm install -g pm2

cd /home/you/novel-reader
pm2 start server/index.js --name novel-reader
pm2 save
pm2 startup   # 按提示执行，实现开机自启
```

若需指定端口和 SESSION_SECRET：

```bash
PORT=3000 SESSION_SECRET="你的随机密钥" pm2 start server/index.js --name novel-reader
```

查看状态：`pm2 status`；看日志：`pm2 logs novel-reader`。

### 5. 手机访问

- 服务器防火墙放行 **3000** 端口（或你设置的 `PORT`）。
- 手机和电脑在同一网络或手机用流量时，在浏览器输入：**http://你的公网IP:3000**  
  例如：`http://123.45.67.89:3000`。

此时已经可以从手机在线看书。

### 6. 可选：域名 + HTTPS（更安全、更好记）

若你有域名并希望用 `https://read.你的域名.com` 访问：

1. **安装 nginx**（以 Ubuntu 为例）：
   ```bash
   sudo apt update && sudo apt install -y nginx certbot python3-certbot-nginx
   ```

2. **申请证书并配置 nginx**：
   ```bash
   sudo certbot --nginx -d read.你的域名.com
   ```
   按提示选择域名并完成证书申请，certbot 会自动写 nginx 配置。

3. **手动配置 nginx 反代**（若 certbot 未自动写好）  
   编辑 `/etc/nginx/sites-available/novel-reader`（或 default）：

   ```nginx
   server {
       listen 80;
       server_name read.你的域名.com;
       location / {
           proxy_pass http://127.0.0.1:3000;
           proxy_http_version 1.1;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
   }
   ```

   然后：
   ```bash
   sudo ln -sf /etc/nginx/sites-available/novel-reader /etc/nginx/sites-enabled/
   sudo nginx -t && sudo systemctl reload nginx
   ```

4. 用 **https://read.你的域名.com** 在手机浏览器打开即可。

---

## 三、方式 B：PaaS 一键部署（Railway / Render 等）

适合「不想管服务器、希望 Git 推送就自动部署」的场景。

### Railway 示例

1. 注册 [Railway](https://railway.app)，新建项目，选择 **Deploy from GitHub** 并选本仓库。
2. 在项目里添加 **Environment Variables**：
   - `PORT`：一般由 Railway 自动提供，可不设或填 `3000`
   - `SESSION_SECRET`：自己填一长串随机字符串
3. 在 **Settings** 里把 **Root Directory** 设为仓库根目录，**Build Command** 填：
   ```bash
   pnpm install && pnpm run build
   ```
   **Start Command** 填：
   ```bash
   node server/index.js
   ```
   （若 Railway 默认用 `npm start`，且你 `package.json` 里 `start` 已是 `node server/index.js`，则不用改 Start Command。）
4. 部署完成后，Railway 会给你一个 `xxx.railway.app` 的域名，手机浏览器打开该链接即可。

### Render 示例

1. 注册 [Render](https://render.com)，New → Web Service，连 GitHub 选仓库。
2. 配置：
   - **Build Command**：`pnpm install && pnpm run build`
   - **Start Command**：`node server/index.js`
   - **Environment**：添加 `SESSION_SECRET`（随机字符串）。
3. 部署完成后用给出的 `xxx.onrender.com` 域名在手机访问。

> 注意：Render 免费实例一段时间无访问会休眠，首次打开可能较慢；数据库（SQLite 文件）在实例重启后可能被清空，重要数据请定期备份或改用持久化存储。

---

## 四、安全检查清单

- [ ] 线上务必设置 **SESSION_SECRET**，不要用代码里的默认值。
- [ ] 若用 VPS，只开放必要端口（如 80/443），应用端口（如 3000）可不对外，交给 nginx 反代。
- [ ] 上线后尽快修改默认管理员密码（默认 `admin` / `admin123`）。

---

## 五、数据与备份

- 书籍和进度在 **server/data/novel-reader.db**。
- 定期备份该文件即可保留全部用户与阅读数据，例如：
  ```bash
  cp server/data/novel-reader.db server/data/novel-reader.db.bak.$(date +%Y%m%d)
  ```

部署完成后，在手机浏览器打开你配置的地址（如 `http://公网IP:3000` 或 `https://你的域名`），登录账号即可在线看书。
