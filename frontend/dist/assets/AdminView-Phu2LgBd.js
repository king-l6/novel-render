import{d as Q,u as W,p as X,c as y,a as c,b as l,w as s,e as a,R as M,B as k,f as g,A as Z,S as ee,M as ae,r as m,q as w,n as d,o as u,j as o,T as V,s as U,t as x,g as I,C as T,F as te,h,I as N,v as se,l as ne}from"./index-OB4_tYqa.js";const le={class:"min-h-screen bg-gray-50 pb-8"},ie={class:"sticky top-0 z-10 flex items-center justify-between px-4 py-3 bg-white border-b border-gray-200 shadow-sm"},oe={class:"flex items-center gap-3"},re={class:"container mx-auto px-4 pt-6 max-w-4xl"},ue={class:"flex items-center justify-between mb-4"},de={key:2,class:"flex flex-wrap gap-1"},me={class:"text-base font-semibold text-gray-800 mb-4"},pe=Q({__name:"AdminView",setup(fe){const j=ne(),_=W(),C=m(!0),A=m([]),p=m(null),E=m(""),S=m([]),z=m(!1),b=m(!1),$=m(!1),f=m(null),r=m({username:"",password:"",is_admin:!1}),q=[{title:"ID",dataIndex:"id",key:"id",width:70},{title:"用户名",dataIndex:"username",key:"username"},{title:"管理员",key:"is_admin",width:80},{title:"注册时间",key:"created_at",width:110},{title:"操作",key:"action",width:200}],R=[{title:"ID",dataIndex:"id",key:"id",width:70},{title:"书名",dataIndex:"title",key:"title",ellipsis:!0},{title:"大小",key:"size",width:90},{title:"添加时间",key:"created_at",width:110},{title:"操作",key:"action",width:80}];function D(t){const e=new Date(t);return Number.isNaN(e.getTime())?"":`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}async function L(){C.value=!0,await _.fetchMe(),C.value=!1,_.isAdmin&&await B()}async function B(){try{A.value=await w.get("/api/admin/users")}catch(t){d.error(t instanceof Error?t.message:"加载用户列表失败")}}function K(){f.value=null,r.value={username:"",password:"",is_admin:!1},b.value=!0}function O(t){f.value=t,r.value={username:t.username,password:"",is_admin:t.is_admin},b.value=!0}async function Y(){const{username:t,password:e,is_admin:n}=r.value,i=String(t).trim();if(!i){d.warning("请输入用户名");return}if(!f.value&&!e){d.warning("请输入密码");return}$.value=!0;try{f.value?(await w.patch(`/api/admin/users/${f.value.id}`,{username:i,...e?{password:e}:{},is_admin:n}),d.success("已更新")):(await w.post("/api/admin/users",{username:i,password:e,is_admin:n}),d.success("已添加")),b.value=!1,await B()}catch(v){d.error(v instanceof Error?v.message:"操作失败")}finally{$.value=!1}}async function G(t){if(confirm(`确定删除用户「${t.username}」？其书籍将一并删除。`))try{await w.delete(`/api/admin/users/${t.id}`),d.success("已删除"),p.value===t.id&&(p.value=null,S.value=[]),await B()}catch(e){d.error(e instanceof Error?e.message:"删除失败")}}async function H(t){p.value=t.id,E.value=t.username,await F()}async function F(){if(p.value!=null){z.value=!0;try{S.value=await w.get(`/api/admin/users/${p.value}/books`)}catch(t){d.error(t instanceof Error?t.message:"加载书籍失败")}finally{z.value=!1}}}async function J(t){if(confirm("确定删除此书？"))try{await w.delete(`/api/admin/books/${t.id}`),d.success("已删除"),await F()}catch(e){d.error(e instanceof Error?e.message:"删除失败")}}function P(){_.logout(),j.replace("/login")}return X(()=>{L()}),(t,e)=>(u(),y("div",le,[c("header",ie,[e[7]||(e[7]=c("h1",{class:"text-lg font-semibold text-gray-800"},"管理员",-1)),c("div",oe,[l(a(M),{to:"/bookshelf",class:"text-sm text-blue-600 hover:underline"},{default:s(()=>[...e[5]||(e[5]=[o("← 返回书架",-1)])]),_:1}),l(a(k),{size:"small",onClick:P},{default:s(()=>[...e[6]||(e[6]=[o("退出",-1)])]),_:1})])]),c("main",re,[!a(_).isAdmin&&!C.value?(u(),g(a(Z),{key:0,type:"warning","show-icon":"",class:"mb-4",message:"仅管理员可访问此页面",description:"请使用管理员账号登录，或返回书架。"},{action:s(()=>[l(a(M),{to:"/bookshelf",class:"text-blue-600 hover:underline"},{default:s(()=>[...e[8]||(e[8]=[o("返回书架",-1)])]),_:1})]),_:1})):(u(),g(a(ee),{key:1,spinning:C.value},{default:s(()=>[l(a(T),{class:"mb-6"},{default:s(()=>[c("div",ue,[e[10]||(e[10]=c("h2",{class:"text-base font-semibold text-gray-800"},"用户列表",-1)),l(a(k),{type:"primary",onClick:K},{default:s(()=>[...e[9]||(e[9]=[o("添加用户",-1)])]),_:1})]),l(a(V),{columns:q,"data-source":A.value,pagination:{pageSize:10},"row-key":"id",size:"small"},{bodyCell:s(({column:n,record:i})=>[n.key==="is_admin"?(u(),y(U,{key:0},[o(x(i.is_admin?"是":"否"),1)],64)):n.key==="created_at"?(u(),y(U,{key:1},[o(x(D(i.created_at)),1)],64)):n.key==="action"?(u(),y("div",de,[l(a(k),{size:"small",onClick:v=>H(i)},{default:s(()=>[...e[11]||(e[11]=[o("书籍",-1)])]),_:1},8,["onClick"]),l(a(k),{size:"small",onClick:v=>O(i)},{default:s(()=>[...e[12]||(e[12]=[o("编辑",-1)])]),_:1},8,["onClick"]),l(a(k),{size:"small",danger:"",onClick:v=>G(i)},{default:s(()=>[...e[13]||(e[13]=[o("删除",-1)])]),_:1},8,["onClick"])])):I("",!0)]),_:1},8,["data-source"])]),_:1}),p.value!=null?(u(),g(a(T),{key:0,class:"mb-6"},{default:s(()=>[c("h2",me," 用户「"+x(E.value)+"」的书架 ",1),l(a(V),{columns:R,"data-source":S.value,loading:z.value,pagination:{pageSize:10},"row-key":"id",size:"small"},{bodyCell:s(({column:n,record:i})=>[n.key==="size"?(u(),y(U,{key:0},[o(x((i.size/1024).toFixed(1))+" KB ",1)],64)):n.key==="created_at"?(u(),y(U,{key:1},[o(x(D(i.created_at)),1)],64)):n.key==="action"?(u(),g(a(k),{key:2,size:"small",danger:"",onClick:v=>J(i)},{default:s(()=>[...e[14]||(e[14]=[o("删除",-1)])]),_:1},8,["onClick"])):I("",!0)]),_:1},8,["data-source","loading"])]),_:1})):I("",!0)]),_:1},8,["spinning"]))]),l(a(ae),{open:b.value,"onUpdate:open":e[4]||(e[4]=n=>b.value=n),title:f.value?"编辑用户":"添加用户","confirm-loading":$.value,"ok-text":"确定","cancel-text":"取消",onOk:Y},{default:s(()=>[l(a(te),{layout:"vertical",model:r.value},{default:s(()=>[l(a(h),{label:"用户名",name:"username",required:""},{default:s(()=>[l(a(N),{value:r.value.username,"onUpdate:value":e[0]||(e[0]=n=>r.value.username=n),placeholder:"用户名",disabled:!!f.value},null,8,["value","disabled"])]),_:1}),f.value?(u(),g(a(h),{key:1,label:"新密码",name:"password"},{default:s(()=>[l(a(N),{value:r.value.password,"onUpdate:value":e[2]||(e[2]=n=>r.value.password=n),type:"password",placeholder:"留空则不修改"},null,8,["value"])]),_:1})):(u(),g(a(h),{key:0,label:"密码",name:"password",required:""},{default:s(()=>[l(a(N),{value:r.value.password,"onUpdate:value":e[1]||(e[1]=n=>r.value.password=n),type:"password",placeholder:"密码"},null,8,["value"])]),_:1})),l(a(h),{name:"is_admin"},{default:s(()=>[l(a(se),{checked:r.value.is_admin,"onUpdate:checked":e[3]||(e[3]=n=>r.value.is_admin=n)},{default:s(()=>[...e[15]||(e[15]=[o("管理员",-1)])]),_:1},8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open","title","confirm-loading"])]))}});export{pe as default};
