import{G as le,r as b,d as oe,p as se,H as ae,x as ie,J as re,c as p,a as m,b as w,w as M,e as i,B as C,t as z,K as ue,L as ce,s as O,D as q,N as J,g as de,O as $,q as R,P as pe,m as ve,l as fe,o as v,j as S,z as me}from"./index-OB4_tYqa.js";const he=le("app",()=>{const u=b("light"),r=b(18),a=b(!1);function t(c){u.value=c,document.body.setAttribute("data-theme",c)}function n(c){r.value=Math.max(14,Math.min(28,c)),document.documentElement.style.setProperty("--font-size",r.value+"px")}function f(){a.value=!a.value}return{theme:u,fontSize:r,paginationMode:a,setTheme:t,setFontSize:n,togglePaginationMode:f}}),ge=/^(ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒé›¶\d]+[ç« å›èŠ‚]|Chapter\s*\d+|[é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ\d]+\s*[ã€ï¼.])\s*.*$/m,K=2200;function xe(u){const r=[],a=u.split(`
`);for(let t=0;t<a.length;t++){const n=a[t].trim();n&&ge.test(n)&&r.push({title:n,index:t})}return r}function U(u){const r=[];let a=0;for(;a<u.length;){let t=Math.min(a+K,u.length);if(t<u.length){const n=u.indexOf(`
`,t);n!==-1&&n-a<K*1.5&&(t=n+1)}r.push(u.slice(a,t)),a=t}return r.length?r:[""]}function _e(u,r){const a=[];if(r.length===0)return u.split(/\n\n+/).forEach(c=>{c.trim()&&a.push({type:"para",content:c.replace(/\n/g,`
`)})}),a;const t=u.split(`
`);let n=[];const f=()=>{n.length&&(a.push({type:"para",content:n.join(`
`)}),n=[])};for(let c=0;c<t.length;c++){const P=t[c],h=P.trim();r.some(d=>d.index===c)?(f(),a.push({type:"chapter",content:h,index:c})):h?n.push(P):f()}return f(),a}const ye=["data-theme"],ke={class:"reader-header flex-shrink-0 flex items-center gap-3 px-4 py-2 border-b shadow-sm z-10"},be={class:"flex-1 text-base font-semibold truncate reader-title"},we={class:"flex items-center gap-1"},Me={class:"text-sm w-6 text-center reader-muted"},Ce={class:"flex-1 flex min-h-0"},ze={class:"reader-sidebar w-60 flex-shrink-0 border-r overflow-y-auto p-3"},Se={key:0,class:"space-y-1 text-sm"},Te=["onClick"],Pe={key:1,class:"text-sm reader-muted"},Be={class:"flex-1 flex flex-col min-w-0"},Ee={key:0,class:"whitespace-pre-wrap break-words"},Ae=["id"],He={key:1,class:"mb-5 indent-8 whitespace-pre-wrap reader-text"},$e={key:0,class:"reader-footer flex-shrink-0 flex items-center gap-3 px-4 py-2 border-t"},Re={key:0,class:"flex items-center gap-2"},Ne={class:"text-xs reader-muted w-10"},Ie={key:1,class:"flex items-center gap-2"},Le={class:"text-sm reader-muted"},Ve={class:"reader-progress-track flex-1 h-1.5 rounded overflow-hidden"},Fe=oe({__name:"ReaderView",setup(u){const r=ve(),a=fe(),t=he(),n=b(null),f=b(null),c=b(!1),P=b(!1),h=b(0),A=b(null),d=b(0),B=$(()=>n.value?xe(n.value.content):[]),_=$(()=>n.value?U(n.value.content):[]),Q=$(()=>n.value?_e(n.value.content,B.value):[]),W=$(()=>(_.value[d.value]??"").split(/\n\n+/).filter(Boolean)),E=$(()=>Number(r.params.id));function X(){G().then(()=>{a.replace("/bookshelf")})}function Y(){var l,e;t.togglePaginationMode(),t.paginationMode&&((e=(l=n.value)==null?void 0:l.progress)==null?void 0:e.page_index)!=null&&(d.value=Math.min(n.value.progress.page_index,_.value.length-1))}const L=["light","sepia","dark"];function Z(){const l=L.indexOf(t.theme),e=L[(l+1)%L.length];t.setTheme(e)}function ee(l){const e=document.getElementById("ch-"+l);e==null||e.scrollIntoView({behavior:"smooth"})}function te(){d.value>0&&(d.value--,D())}function ne(){d.value<_.value.length-1&&(d.value++,D())}let N;function I(){var s;const l=f.value;if(!l||t.paginationMode)return;const{scrollTop:e,scrollHeight:x,clientHeight:o}=l;h.value=x<=o?100:Math.round(e/(x-o)*100);const y=e+o/2;for(let g=B.value.length-1;g>=0;g--){const T=document.getElementById("ch-"+B.value[g].index);if(T&&T.offsetTop<=y){A.value=B.value[g].index;return}}A.value=((s=B.value[0])==null?void 0:s.index)??null,clearTimeout(N),N=setTimeout(()=>{const g=_.value.length,T=g<=1?0:Math.min(Math.floor(h.value/100*g),g-1);R.put(`/api/books/${E.value}/progress`,{scroll_top:l.scrollTop,percent:h.value,page_index:T}).catch(()=>{})},500)}function D(){const l=_.value.length,e=l<=1?100:Math.round((d.value+1)/l*100);R.put(`/api/books/${E.value}/progress`,{scroll_top:0,percent:e,page_index:d.value}).catch(()=>{})}function G(){if(clearTimeout(N),!n.value||!Number(r.params.id))return Promise.resolve();const l=E.value;if(t.paginationMode){const y=_.value.length,s=y<=1?100:Math.round((d.value+1)/y*100);return R.put(`/api/books/${l}/progress`,{scroll_top:0,percent:s,page_index:d.value}).catch(()=>{})}const e=f.value;if(!e)return Promise.resolve();const x=_.value.length,o=x<=1?0:Math.min(Math.floor(h.value/100*x),x-1);return R.put(`/api/books/${l}/progress`,{scroll_top:e.scrollTop,percent:h.value,page_index:o}).catch(()=>{})}async function V(){var e,x;const l=E.value;if(!(!l||!Number(l))){(e=f.value)==null||e.removeEventListener("scroll",I),clearTimeout(N),n.value=null,h.value=0,d.value=0,A.value=null;try{const o=await R.get(`/api/books/${l}`),y=o.content.replace(/\r\n/g,`
`).replace(/\r/g,`
`);o.content=y,n.value=o;const s=o.progress,g=U(y);if(t.paginationMode)(s==null?void 0:s.page_index)!=null&&s.page_index>0?d.value=Math.min(s.page_index,g.length-1):(s==null?void 0:s.percent)!=null&&s.percent>0&&g.length>0&&(d.value=Math.min(Math.floor(s.percent/100*g.length),g.length-1));else{const T=(s==null?void 0:s.scroll_top)!=null&&s.scroll_top>0?s.scroll_top:null,H=(s==null?void 0:s.percent)!=null&&s.percent>0?s.percent:null;if(await pe(),f.value&&(T!=null||H!=null)){const F=()=>{const k=f.value;if(k){if(T!=null)k.scrollTop=T;else if(H!=null){const j=k.scrollHeight-k.clientHeight;j>0&&(k.scrollTop=H/100*j)}H!=null?h.value=H:k.scrollHeight>k.clientHeight&&(h.value=Math.round(k.scrollTop/(k.scrollHeight-k.clientHeight)*100))}};F(),requestAnimationFrame(()=>{requestAnimationFrame(F)}),setTimeout(F,150)}}(x=f.value)==null||x.addEventListener("scroll",I),I()}catch{n.value=null,a.replace("/bookshelf")}}}return se(()=>{document.body.setAttribute("data-theme",t.theme),V()}),ae(E,(l,e)=>{e!==void 0&&String(l)!==String(e)&&V()}),ie(()=>{var l;((l=n.value)==null?void 0:l.id)!==E.value&&V()}),re(()=>{var l;(l=f.value)==null||l.removeEventListener("scroll",I),G()}),(l,e)=>{var x;return v(),p("div",{class:"reader-view h-screen flex flex-col","data-theme":i(t).theme},[m("header",ke,[w(i(C),{type:"text",size:"large",onClick:X},{default:M(()=>[...e[4]||(e[4]=[S("â†",-1)])]),_:1}),w(i(C),{type:"text",size:"large",onClick:e[0]||(e[0]=o=>c.value=!c.value)},{default:M(()=>[...e[5]||(e[5]=[S("â‰¡",-1)])]),_:1}),m("h1",be,z(((x=n.value)==null?void 0:x.title)||"åŠ è½½ä¸­â€¦"),1),m("div",we,[w(i(C),{type:"text",size:"middle",onClick:Y,title:i(t).paginationMode?"åˆ†é¡µæ¨¡å¼":"æ™®é€šæ¨¡å¼"},{default:M(()=>[...e[6]||(e[6]=[S("ğŸ“„",-1)])]),_:1},8,["title"]),w(i(C),{type:"text",size:"middle",onClick:Z},{default:M(()=>[...e[7]||(e[7]=[S("ğŸŒ“",-1)])]),_:1}),w(i(C),{type:"text",size:"middle",onClick:e[1]||(e[1]=o=>i(t).setFontSize(i(t).fontSize-2))},{default:M(()=>[...e[8]||(e[8]=[S("A-",-1)])]),_:1}),m("span",Me,z(i(t).fontSize),1),w(i(C),{type:"text",size:"middle",onClick:e[2]||(e[2]=o=>i(t).setFontSize(i(t).fontSize+2))},{default:M(()=>[...e[9]||(e[9]=[S("A+",-1)])]),_:1}),w(i(C),{type:"text",size:"middle",onClick:e[3]||(e[3]=o=>P.value=!P.value)},{default:M(()=>[...e[10]||(e[10]=[S("â›¶",-1)])]),_:1})])]),m("div",Ce,[ue(m("aside",ze,[e[11]||(e[11]=m("h3",{class:"text-sm mb-2 border-b pb-2 reader-muted"},"ç›®å½•",-1)),B.value.length?(v(),p("ul",Se,[(v(!0),p(O,null,q(B.value,o=>(v(),p("li",{key:o.index,class:me(["reader-toc-item py-1 px-2 rounded cursor-pointer",{"reader-toc-active":A.value===o.index}]),onClick:y=>ee(o.index)},z(o.title.length>18?o.title.slice(0,18)+"â€¦":o.title),11,Te))),128))])):(v(),p("p",Pe,"æ— ç« èŠ‚æ ‡é¢˜"))],512),[[ce,c.value&&!P.value]]),m("main",Be,[m("div",{ref_key:"contentRef",ref:f,class:"reader-content flex-1 overflow-y-auto px-6 py-4 max-w-3xl mx-auto w-full leading-[1.8]",style:J({fontSize:i(t).fontSize+"px"})},[i(t).paginationMode?(v(),p("div",Ee,[(v(!0),p(O,null,q(W.value,(o,y)=>(v(),p("p",{key:y,class:"mb-5 indent-8 reader-text"},z(o),1))),128))])):(v(!0),p(O,{key:1},q(Q.value,o=>(v(),p("div",{key:o.index??o.content.slice(0,20)},[o.type==="chapter"?(v(),p("h2",{key:0,id:"ch-"+o.index,class:"reader-chapter font-semibold mt-8 mb-3 text-lg leading-snug"},z(o.content),9,Ae)):(v(),p("p",He,z(o.content),1))]))),128))],4),P.value?de("",!0):(v(),p("div",$e,[i(t).paginationMode?(v(),p("div",Ie,[w(i(C),{type:"text",size:"small",onClick:te},{default:M(()=>[...e[13]||(e[13]=[S("â€¹",-1)])]),_:1}),m("span",Le,"ç¬¬ "+z(d.value+1)+" / "+z(_.value.length)+" é¡µ",1),w(i(C),{type:"text",size:"small",onClick:ne},{default:M(()=>[...e[14]||(e[14]=[S("â€º",-1)])]),_:1})])):(v(),p("div",Re,[e[12]||(e[12]=m("span",{class:"text-xs reader-muted"},"é˜…è¯»è¿›åº¦",-1)),m("span",Ne,z(h.value)+"%",1)])),m("div",Ve,[m("div",{class:"reader-progress-fill h-full rounded transition-all",style:J({width:(i(t).paginationMode?_.value.length?(d.value+1)/_.value.length*100:100:h.value)+"%"})},null,4)])]))])])],8,ye)}}}),Oe=(u,r)=>{const a=u.__vccOpts||u;for(const[t,n]of r)a[t]=n;return a},Ge=Oe(Fe,[["__scopeId","data-v-7d6777c2"]]);export{Ge as default};
