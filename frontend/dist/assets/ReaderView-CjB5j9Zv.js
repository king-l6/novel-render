import{x as X,r as g,d as Y,p as Z,q as $,y as ee,z as te,c as u,a as p,b as m,w as x,e as a,B as h,t as y,D as ne,G as se,s as A,v as I,H as F,g as le,h as oe,J as M,o as d,l as b,i as ae,K as ie}from"./index-fns_V41u.js";const re=X("app",()=>{const c=g("light"),r=g(18),l=g(!1);function t(i){c.value=i,document.body.setAttribute("data-theme",i)}function n(i){r.value=Math.max(14,Math.min(28,i)),document.documentElement.style.setProperty("--font-size",r.value+"px")}function f(){l.value=!l.value}return{theme:c,fontSize:r,paginationMode:l,setTheme:t,setFontSize:n,togglePaginationMode:f}}),ue=/^(ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒé›¶\d]+[ç« å›èŠ‚]|Chapter\s*\d+|[é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ\d]+\s*[ã€ï¼.])\s*.*$/m,D=2200;function de(c){const r=[],l=c.split(`
`);for(let t=0;t<l.length;t++){const n=l[t].trim();n&&ue.test(n)&&r.push({title:n,index:t})}return r}function G(c){const r=[];let l=0;for(;l<c.length;){let t=Math.min(l+D,c.length);if(t<c.length){const n=c.indexOf(`
`,t);n!==-1&&n-l<D*1.5&&(t=n+1)}r.push(c.slice(l,t)),l=t}return r.length?r:[""]}function ce(c,r){const l=[];if(r.length===0)return c.split(/\n\n+/).forEach(i=>{i.trim()&&l.push({type:"para",content:i.replace(/\n/g,`
`)})}),l;const t=c.split(`
`);let n=[];const f=()=>{n.length&&(l.push({type:"para",content:n.join(`
`)}),n=[])};for(let i=0;i<t.length;i++){const k=t[i],w=k.trim();r.some(v=>v.index===i)?(f(),l.push({type:"chapter",content:w,index:i})):w?n.push(k):f()}return f(),l}const pe={class:"h-screen flex flex-col bg-gray-100"},ve={class:"flex-shrink-0 flex items-center gap-3 px-4 py-2 bg-white border-b border-gray-200 shadow-sm z-10"},fe={class:"flex-1 text-base font-semibold truncate"},ge={class:"flex items-center gap-1"},me={class:"text-sm text-gray-500 w-6 text-center"},xe={class:"flex-1 flex min-h-0"},he={class:"w-60 flex-shrink-0 border-r border-gray-200 bg-white overflow-y-auto p-3"},ye={key:0,class:"space-y-1 text-sm"},be=["onClick"],_e={key:1,class:"text-gray-400 text-sm"},ke={class:"flex-1 flex flex-col min-w-0"},we={key:0,class:"whitespace-pre-wrap break-words"},Ce=["id"],ze={key:1,class:"mb-4 indent-8 whitespace-pre-wrap"},Me={key:0,class:"flex-shrink-0 flex items-center gap-3 px-4 py-2 bg-white border-t border-gray-200"},Se={key:0,class:"flex items-center gap-2"},Pe={class:"text-xs text-gray-500 w-10"},Te={key:1,class:"flex items-center gap-2"},Be={class:"text-sm text-gray-500"},Ee={class:"flex-1 h-1.5 bg-gray-200 rounded overflow-hidden"},$e=Y({__name:"ReaderView",setup(c){const r=ae(),l=oe(),t=re(),n=g(null),f=g(null),i=g(!1),k=g(!1),w=g(0),S=g(null),v=g(0),C=M(()=>n.value?de(n.value.content):[]),z=M(()=>n.value?G(n.value.content):[]),O=M(()=>n.value?ce(n.value.content,C.value):[]),j=M(()=>(z.value[v.value]??"").split(/\n\n+/).filter(Boolean)),B=M(()=>Number(r.params.id));function q(){l.replace("/bookshelf")}function J(){var o,e;t.togglePaginationMode(),t.paginationMode&&((e=(o=n.value)==null?void 0:o.progress)==null?void 0:e.page_index)!=null&&(v.value=Math.min(n.value.progress.page_index,z.value.length-1))}const E=["light","sepia","dark"];function K(){const o=E.indexOf(t.theme),e=E[(o+1)%E.length];t.setTheme(e),document.body.setAttribute("data-theme",e)}function U(o){const e=document.getElementById("ch-"+o);e==null||e.scrollIntoView({behavior:"smooth"})}function Q(){v.value>0&&(v.value--,V())}function W(){v.value<z.value.length-1&&(v.value++,V())}let N;function R(){var H;const o=f.value;if(!o||t.paginationMode)return;const{scrollTop:e,scrollHeight:_,clientHeight:s}=o;w.value=_<=s?100:Math.round(e/(_-s)*100);const P=e+s/2;for(let T=C.value.length-1;T>=0;T--){const L=document.getElementById("ch-"+C.value[T].index);if(L&&L.offsetTop<=P){S.value=C.value[T].index;return}}S.value=((H=C.value[0])==null?void 0:H.index)??null,clearTimeout(N),N=setTimeout(()=>{$.put(`/api/books/${B.value}/progress`,{scroll_top:o.scrollTop,percent:w.value}).catch(()=>{})},500)}function V(){const o=z.value.length,e=o<=1?100:Math.round((v.value+1)/o*100);$.put(`/api/books/${B.value}/progress`,{scroll_top:0,percent:e,page_index:v.value}).catch(()=>{})}return Z(async()=>{var o,e,_;try{n.value=await $.get(`/api/books/${B.value}`);const s=n.value.content.replace(/\r\n/g,`
`).replace(/\r/g,`
`);n.value.content=s,((o=n.value.progress)==null?void 0:o.page_index)!=null&&(v.value=Math.min(n.value.progress.page_index,G(s).length-1)),!t.paginationMode&&((e=n.value.progress)==null?void 0:e.scroll_top)!=null&&(await ee(),f.value&&(f.value.scrollTop=n.value.progress.scroll_top)),(_=f.value)==null||_.addEventListener("scroll",R),R()}catch{n.value=null,l.replace("/bookshelf")}}),te(()=>{var o;(o=f.value)==null||o.removeEventListener("scroll",R)}),(o,e)=>{var _;return d(),u("div",pe,[p("header",ve,[m(a(h),{type:"text",size:"large",onClick:q},{default:x(()=>[...e[4]||(e[4]=[b("â†",-1)])]),_:1}),m(a(h),{type:"text",size:"large",onClick:e[0]||(e[0]=s=>i.value=!i.value)},{default:x(()=>[...e[5]||(e[5]=[b("â‰¡",-1)])]),_:1}),p("h1",fe,y(((_=n.value)==null?void 0:_.title)||"åŠ è½½ä¸­â€¦"),1),p("div",ge,[m(a(h),{type:"text",size:"middle",onClick:J,title:a(t).paginationMode?"åˆ†é¡µæ¨¡å¼":"æ™®é€šæ¨¡å¼"},{default:x(()=>[...e[6]||(e[6]=[b("ğŸ“„",-1)])]),_:1},8,["title"]),m(a(h),{type:"text",size:"middle",onClick:K},{default:x(()=>[...e[7]||(e[7]=[b("ğŸŒ“",-1)])]),_:1}),m(a(h),{type:"text",size:"middle",onClick:e[1]||(e[1]=s=>a(t).setFontSize(a(t).fontSize-2))},{default:x(()=>[...e[8]||(e[8]=[b("A-",-1)])]),_:1}),p("span",me,y(a(t).fontSize),1),m(a(h),{type:"text",size:"middle",onClick:e[2]||(e[2]=s=>a(t).setFontSize(a(t).fontSize+2))},{default:x(()=>[...e[9]||(e[9]=[b("A+",-1)])]),_:1}),m(a(h),{type:"text",size:"middle",onClick:e[3]||(e[3]=s=>k.value=!k.value)},{default:x(()=>[...e[10]||(e[10]=[b("â›¶",-1)])]),_:1})])]),p("div",xe,[ne(p("aside",he,[e[11]||(e[11]=p("h3",{class:"text-sm text-gray-500 mb-2 border-b pb-2"},"ç›®å½•",-1)),C.value.length?(d(),u("ul",ye,[(d(!0),u(A,null,I(C.value,s=>(d(),u("li",{key:s.index,class:ie(["py-1 px-2 rounded cursor-pointer hover:bg-amber-50",{"bg-amber-100 border-l-2 border-amber-600":S.value===s.index}]),onClick:P=>U(s.index)},y(s.title.length>18?s.title.slice(0,18)+"â€¦":s.title),11,be))),128))])):(d(),u("p",_e,"æ— ç« èŠ‚æ ‡é¢˜"))],512),[[se,i.value&&!k.value]]),p("main",ke,[p("div",{ref_key:"contentRef",ref:f,class:"flex-1 overflow-y-auto px-6 py-4 max-w-3xl mx-auto w-full",style:F({fontSize:a(t).fontSize+"px"})},[a(t).paginationMode?(d(),u("div",we,[(d(!0),u(A,null,I(j.value,(s,P)=>(d(),u("p",{key:P,class:"mb-4 indent-8"},y(s),1))),128))])):(d(!0),u(A,{key:1},I(O.value,s=>(d(),u("div",{key:s.index??s.content.slice(0,20)},[s.type==="chapter"?(d(),u("h2",{key:0,id:"ch-"+s.index,class:"text-amber-700 font-semibold mt-8 mb-3 text-lg"},y(s.content),9,Ce)):(d(),u("p",ze,y(s.content),1))]))),128))],4),k.value?le("",!0):(d(),u("div",Me,[a(t).paginationMode?(d(),u("div",Te,[m(a(h),{type:"text",size:"small",onClick:Q},{default:x(()=>[...e[13]||(e[13]=[b("â€¹",-1)])]),_:1}),p("span",Be,"ç¬¬ "+y(v.value+1)+" / "+y(z.value.length)+" é¡µ",1),m(a(h),{type:"text",size:"small",onClick:W},{default:x(()=>[...e[14]||(e[14]=[b("â€º",-1)])]),_:1})])):(d(),u("div",Se,[e[12]||(e[12]=p("span",{class:"text-xs text-gray-500"},"é˜…è¯»è¿›åº¦",-1)),p("span",Pe,y(w.value)+"%",1)])),p("div",Ee,[p("div",{class:"h-full bg-amber-500 rounded transition-all",style:F({width:(a(t).paginationMode?z.value.length?(v.value+1)/z.value.length*100:100:w.value)+"%"})},null,4)])]))])])])}}});export{$e as default};
